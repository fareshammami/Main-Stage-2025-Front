<div class="user-stream-container">

  <!-- Header + Totals merged -->
  <div class="user-header-state-card">
    <div class="user-info">
      <h2>{{ username || userId }}</h2>
    </div>
    <div class="user-totals" *ngIf="netTotal !== null" [class.updated]="totalsUpdated">
      <div class="totals-label">ðŸ’° Net Total</div>
      <div class="totals-value">ðŸ’° {{ netTotal.toFixed(2) }}</div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="message error">{{ errorMessage }}</div>
  <div *ngIf="successMessage" class="message success">{{ successMessage }}</div>
  <div *ngIf="loading" class="loading">Chargement...</div>

  <!-- Action Buttons -->
  <div class="actions-card">
    <button class="action-btn" (click)="toggleForm('indu')">âž• Add Indu</button>
    <button class="action-btn" (click)="toggleForm('comp')">ðŸ’° Add Compensation</button>
  </div>

  <!-- Forms -->
  <div class="form-card slide" [class.active]="showAddIndu">
    <div class="form-card-header"><h3>âž• Add Indu Error</h3></div>
    <div class="form-card-body">
      <div *ngIf="induErrorMessage" class="message error">{{ induErrorMessage }}</div>
      <div *ngIf="induSuccessMessage" class="message success">{{ induSuccessMessage }}</div>
      <div class="form-group">
        <input type="number" [(ngModel)]="newInduAmount" placeholder="Montant erreur Indu" />
        <button class="submit-btn" (click)="addInduError()">Ajouter</button>
      </div>
    </div>
  </div>

  <div class="form-card slide" [class.active]="showAddCompensation">
    <div class="form-card-header"><h3>ðŸ’° Add Compensation</h3></div>
    <div class="form-card-body">
      <div *ngIf="compErrorMessage" class="message error">{{ compErrorMessage }}</div>
      <div *ngIf="compSuccessMessage" class="message success">{{ compSuccessMessage }}</div>
      <div class="form-group">
        <input type="number" [(ngModel)]="newCompensationAmount" placeholder="Montant compensation" />
        <button class="submit-btn" (click)="addCompensation()">Ajouter</button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filter-options">
      <label><input type="radio" name="filter" value="ALL" (change)="changeFilter('ALL')" [checked]="currentFilter==='ALL'"> Tous</label>
      <label><input type="radio" name="filter" value="ONLY_HANDLED" (change)="changeFilter('ONLY_HANDLED')" [checked]="currentFilter==='ONLY_HANDLED'"> TraitÃ©s</label>
      <label><input type="radio" name="filter" value="ONLY_UNHANDLED" (change)="changeFilter('ONLY_UNHANDLED')" [checked]="currentFilter==='ONLY_UNHANDLED'"> Non traitÃ©s</label>
    </div>
    <div class="filter-type">
      <label>Type of events:</label>
      <select [(ngModel)]="selectedEventType" (change)="loadStream()">
        <option value="">Tous</option>
        <option value="InduErrorCreatedEvent">InduErrorCreatedEvent</option>
        <option value="CompensationCreatedEvent">CompensationCreatedEvent</option>
      </select>
    </div>
    <div class="filter-date">
      <label>From:</label>
      <input type="date" [(ngModel)]="fromDate" (change)="loadStream()" />
      <label>To:</label>
      <input type="date" [(ngModel)]="toDate" (change)="loadStream()" />
    </div>
  </div>

  <hr />

  <!-- Events Table -->
  <h3>Events Received</h3>
  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Type of Event</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let event of events">
          <td>{{ event.eventType }}</td>
          <td>{{ getAmount(event) }}</td>
          <td>{{ getStatus(event) }}</td>
          <td>
            <ng-container *ngIf="event.createdAt !== 'N/A'; else noDate">
              {{ event.createdAt | date:'short' }}
            </ng-container>
            <ng-template #noDate>
              <span class="badge na">N/A</span>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button (click)="prevPage()" [disabled]="currentPage===0">Previous</button>
    <span>Page {{ currentPage + 1 }}</span>
    <button (click)="nextPage()" [disabled]="events.length < pageSize">Next</button>
  </div>

  <!-- Process User -->
  <div class="process-errors-card">
    <button class="process-btn" (click)="processErrors()">âš¡ Process the user</button>
  </div>

</div>
